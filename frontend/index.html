<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Kit Prep</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-teal-600">Meal Kit Prep</h1>
            <div>
                <button id="home-btn" class="text-gray-600 hover:text-teal-600 font-medium">Home</button>
                <button id="register-nav-btn" class="ml-4 bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition duration-300">Register</button>
                <button id="dashboard-nav-btn" class="ml-4 text-gray-600 hover:text-teal-600 font-medium hidden">Dashboard</button>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto px-6 py-8">

        <!-- Welcome Page -->
        <div id="welcome-page" class="page active text-center">
            <div class="bg-white p-10 rounded-xl shadow-lg">
                <h2 class="text-4xl font-bold mb-4">Your Culinary Adventure Awaits!</h2>
                <p class="text-gray-600 mb-8 max-w-2xl mx-auto">Fresh, pre-portioned ingredients and delicious recipes delivered to your door. Create an account to get started.</p>
                <button id="get-started-btn" class="bg-teal-500 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-teal-600 transition duration-300">Get Started</button>
            </div>
        </div>

        <!-- Registration Page (Structure only, logic is in JS) -->
        <div id="register-page" class="page"></div>
        
        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page">
            <div id="dashboard-content" class="space-y-8">
                <!-- Content will be rendered by JS -->
                <p>Loading your data...</p>
            </div>
        </div>

    </main>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api';
        const state = { 
            currentUser: null, // e.g., { customerId: 101, name: "Alice" }
            masterData: { allergies: [], preferences: [], plans: [] } // Added plans
        };

        // --- Page Element References ---
        const pages = {
            welcome: document.getElementById('welcome-page'),
            register: document.getElementById('register-page'),
            dashboard: document.getElementById('dashboard-page')
        };
        const navLinks = {
            home: document.getElementById('home-btn'),
            register: document.getElementById('register-nav-btn'),
            getStarted: document.getElementById('get-started-btn'),
            dashboard: document.getElementById('dashboard-nav-btn'),
        };
        const dashboardContent = document.getElementById('dashboard-content');

        // --- Page Navigation ---
        function showPage(pageId) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            if (pages[pageId]) pages[pageId].classList.add('active');
        }
        
        // --- API Calls ---
        async function apiFetch(endpoint, options = {}) {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `API request to ${endpoint} failed`);
            }
            return data;
        }

        async function fetchMasterData() {
            const data = await apiFetch('/master-data');
            // A real app would get plans too, hardcoding for now.
            state.masterData = { ...data, plans: [{Plan_ID: 1, Plan_Name: 'Weekly Solo'}, {Plan_ID: 2, Plan_Name: 'Weekly Couple'}] };
        }

        // --- Rendering Logic ---
        function renderRegisterPage() {
            pages.register.innerHTML = `
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-center mb-6">Create Your Account</h2>
                <form id="registration-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" name="name" placeholder="Full Name" class="w-full p-3 border rounded-lg" required>
                        <input type="email" name="email" placeholder="Email Address" class="w-full p-3 border rounded-lg" required>
                        <input type="tel" name="phone" placeholder="Phone Number" class="w-full p-3 border rounded-lg">
                        <input type="text" name="address" placeholder="Address" class="w-full p-3 border rounded-lg" required>
                        <input type="text" name="city" placeholder="City" class="w-full p-3 border rounded-lg" required>
                        <input type="text" name="state" placeholder="State" class="w-full p-3 border rounded-lg" required>
                        <input type="text" name="pincode" placeholder="Pincode" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div class="mb-6"><h3 class="font-semibold text-lg mb-2">Allergies?</h3><div id="allergies-container" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div></div>
                    <div class="mb-6"><h3 class="font-semibold text-lg mb-2">Preferences?</h3><div id="preferences-container" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div></div>
                    <button type="submit" class="w-full bg-teal-500 text-white font-bold py-3 rounded-lg">Register</button>
                </form>
                <div id="form-message" class="mt-4 text-center"></div>
            </div>`;
            renderCheckboxes('allergies', state.masterData.allergies, 'Allergy_ID', 'Allergy_Name');
            renderCheckboxes('preferences', state.masterData.preferences, 'Preference_ID', 'Preference_Name');
            document.getElementById('registration-form').addEventListener('submit', handleRegister);
        }

        function renderCheckboxes(type, items, idKey, nameKey) {
            const container = document.getElementById(`${type}-container`);
            if(!container) return;
            container.innerHTML = items.map(item => `
                <label class="flex items-center space-x-2 p-2 rounded-lg border hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" name="${type}" value="${item[idKey]}" class="h-4 w-4 rounded text-teal-600">
                    <span>${item[nameKey]}</span>
                </label>
            `).join('');
        }

        async function fetchAndRenderDashboard(customerId) {
            dashboardContent.innerHTML = `<p>Loading your data...</p>`;
            try {
                const data = await apiFetch(`/dashboard/${customerId}`);
                renderDashboard(data);
            } catch (error) {
                dashboardContent.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }

        function renderDashboard({ summary, activeOrders }) {
            const recommendationsHtml = `<div id="recommendations-container" class="bg-white p-8 rounded-xl shadow-lg"><p>Loading recommendations...</p></div>`;
            const placeOrderHtml = `<div id="place-order-container" class="bg-white p-8 rounded-xl shadow-lg"><p>Loading order form...</p></div>`;

            dashboardContent.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg mb-8">
                    <h3 class="text-2xl font-semibold">${summary.Customer_Name}</h3>
                    <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                        <div><p class="text-sm text-gray-500">Total Orders</p><p class="text-2xl font-bold">${summary.TotalOrders}</p></div>
                        <div><p class="text-sm text-gray-500">Lifetime Value</p><p class="text-2xl font-bold">$${parseFloat(summary.LifetimeValue).toFixed(2)}</p></div>
                    </div>
                </div>
                ${recommendationsHtml}
                ${placeOrderHtml}
            `;
            fetchAndRenderRecommendations(state.currentUser.customerId);
        }

        async function fetchAndRenderRecommendations(customerId) {
            const container = document.getElementById('recommendations-container');
            const orderContainer = document.getElementById('place-order-container');
            try {
                const recommendations = await apiFetch(`/mealkits/recommendations/${customerId}`);
                container.innerHTML = `
                    <h4 class="text-xl font-semibold mb-4">Meal Kits Recommended For You</h4>
                    ${recommendations.length > 0 ? `
                        <div class="grid md:grid-cols-3 gap-4">
                            ${recommendations.map(kit => `
                                <div class="border p-4 rounded-lg">
                                    <p class="font-bold">${kit.Name}</p>
                                    <p class="text-sm text-gray-500">${kit.Cuisine} - ${kit.Calories} cal</p>
                                </div>`).join('')}
                        </div>` : `<p class="text-gray-500">No specific recommendations found.</p>`}
                `;
                renderOrderForm(recommendations);
            } catch (error) {
                container.innerHTML = `<p class="text-red-500">Could not load recommendations.</p>`;
                orderContainer.innerHTML = `<p class="text-red-500">Could not load order form.</p>`;
            }
        }

        function renderOrderForm(availableKits) {
            const container = document.getElementById('place-order-container');
            container.innerHTML = `
                <h4 class="text-xl font-semibold mb-4">Place a New Order</h4>
                <form id="order-form">
                    <div class="mb-4">
                        <label class="block font-medium mb-1">Select a Plan</label>
                        <select name="plan_id" class="w-full p-2 border rounded-lg">
                            ${state.masterData.plans.map(p => `<option value="${p.Plan_ID}">${p.Plan_Name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block font-medium mb-1">Choose your Meal Kits</label>
                        <div class="grid grid-cols-2 gap-2">
                        ${availableKits.map(kit => `
                            <label class="flex items-center space-x-2 p-2 rounded-lg border hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" name="mealkit_ids" value="${kit.MealKit_ID}" class="h-4 w-4 rounded text-teal-600">
                                <span>${kit.Name}</span>
                            </label>`).join('')}
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg">Place Order</button>
                </form>
                <div id="order-message" class="mt-4 text-center"></div>
            `;
            document.getElementById('order-form').addEventListener('submit', handlePlaceOrder);
        }

        // --- Event Handlers ---
        async function handleRegister(e) {
            e.preventDefault();
            const formMessage = document.getElementById('form-message');
            formMessage.textContent = 'Registering...';
            const formData = Object.fromEntries(new FormData(e.target).entries());
            formData.allergy_ids = Array.from(e.target.querySelectorAll('input[name="allergies"]:checked')).map(el => el.value).join(',');
            formData.preference_ids = Array.from(e.target.querySelectorAll('input[name="preferences"]:checked')).map(el => el.value).join(',');

            try {
                const result = await apiFetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });
                formMessage.textContent = `Success! Welcome, ${formData.name}.`;
                state.currentUser = { customerId: result.customerId, name: formData.name };
                updateUIForLoggedInUser();
                setTimeout(() => {
                    showPage('dashboard');
                    fetchAndRenderDashboard(state.currentUser.customerId);
                }, 1500);
            } catch (error) {
                formMessage.textContent = `Error: ${error.message}`;
            }
        }

        async function handlePlaceOrder(e) {
            e.preventDefault();
            const orderMessage = document.getElementById('order-message');
            orderMessage.textContent = 'Placing order...';
            const formData = Object.fromEntries(new FormData(e.target).entries());
            const selectedKits = Array.from(e.target.querySelectorAll('input[name="mealkit_ids"]:checked')).map(el => el.value);

            if (selectedKits.length === 0) {
                orderMessage.textContent = 'Please select at least one meal kit.';
                return;
            }

            const payload = {
                customer_id: state.currentUser.customerId,
                plan_id: formData.plan_id,
                mealkit_ids: selectedKits.join(','),
                payment_method: 'Credit Card' // Hardcoded for simplicity
            };

            try {
                const result = await apiFetch('/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                orderMessage.textContent = `Order #${result.orderId} placed successfully!`;
                // Refresh dashboard to show the new order
                setTimeout(() => fetchAndRenderDashboard(state.currentUser.customerId), 2000);
            } catch (error) {
                orderMessage.textContent = `Error: ${error.message}`;
            }
        }

        function updateUIForLoggedInUser() {
            if (state.currentUser) {
                navLinks.register.style.display = 'none';
                navLinks.dashboard.style.display = 'inline-block';
            }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            navLinks.home.addEventListener('click', () => showPage('welcome'));
            navLinks.register.addEventListener('click', () => {
                renderRegisterPage();
                showPage('register');
            });
            navLinks.getStarted.addEventListener('click', () => {
                renderRegisterPage();
                showPage('register');
            });
            navLinks.dashboard.addEventListener('click', () => {
                if (state.currentUser) {
                    showPage('dashboard');
                    fetchAndRenderDashboard(state.currentUser.customerId);
                }
            });
            showPage('welcome');
            fetchMasterData();
        });
    </script>
</body>
</html>

